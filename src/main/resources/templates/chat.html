<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Application</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.1/stomp.min.js"></script>
    <style>
        :root {
          --bg-dark: #0f172a;
          --bg-card: rgba(30, 41, 59, 0.8);
          --bg-input: #1e293b;
          --text-light: #f1f5f9;
          --text-muted: #94a3b8;
          --accent: #3b82f6;
          --bubble-me: #3b82f6;
          --bubble-other: #334155;
        }

        body, html {
          height: 100%;
          background: var(--bg-dark);
          color: var(--text-light);
          font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
        }

        .chat-shell {
          max-width: 1000px;
          margin: 1.5rem auto;
          height: calc(100vh - 3rem);
          display: grid;
          grid-template-rows: auto 1fr auto;
          gap: 0.75rem;
        }

        /* Header */
        .chat-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 0.75rem 1rem;
          border-radius: 1rem;
          background: var(--bg-card);
          backdrop-filter: blur(10px);
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
        }

        /* Chat body */
        .chat-body {
          display: flex;
          gap: 1rem;
          height: 100%;
        }

        /* Messages panel */
        .messages {
          flex: 1 1 0;
          border-radius: 1rem;
          padding: 1rem;
          background: var(--bg-card);
          border: 1px solid rgba(255, 255, 255, 0.08);
          overflow-y: auto;
          display: flex;
          flex-direction: column;
          gap: 0.6rem;
          min-height: 0;
          scroll-behavior: smooth;
        }

        /* Message bubble row */
        .message-row {
          display: flex;
          gap: 0.75rem;
          align-items: flex-end;
          animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(5px); }
          to { opacity: 1; transform: translateY(0); }
        }

        /* Avatars */
        .avatar {
          width: 40px; height: 40px; border-radius: 50%;
          display: inline-flex; align-items: center; justify-content: center;
          font-weight: bold; color: #fff;
          flex-shrink: 0;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* Chat bubbles */
        .bubble {
          max-width: 75%;
          padding: 0.5rem 0.75rem;
          border-radius: 1rem;
          font-size: 0.95rem;
          line-height: 1.4;
          color: #fff;
        }
        .bubble.me {
          background: var(--bubble-me);
          border-bottom-right-radius: 0.3rem;
        }
        .bubble.other {
          background: var(--bubble-other);
          border-bottom-left-radius: 0.3rem;
        }

        .meta {
          font-size: 0.75rem;
          color: var(--text-muted);
          margin-top: 0.2rem;
        }

        /* Sidebar */
        .sidebar {
          width: 240px;
          border-radius: 1rem;
          padding: 0.75rem;
          background: var(--bg-card);
          border: 1px solid rgba(255, 255, 255, 0.08);
          display: flex;
          flex-direction: column;
          gap: 0.75rem;
        }
        .status-dot {
          width: 10px; height: 10px; border-radius: 50%;
          display: inline-block; margin-right: 0.5rem;
        }
        .status-online { background: #22c55e; }
        .status-offline { background: #64748b; }

        /* Chat input */
        .chat-input {
          display: flex;
          gap: 0.5rem;
          align-items: center;
          padding: 0.5rem;
          border-radius: 1rem;
          background: var(--bg-card);
          border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .chat-input .form-control {
          background: var(--bg-input);
          color: var(--text-light);
          border: none;
          border-radius: 0.75rem;
          height: 46px;
          transition: background 0.2s;
        }
        .chat-input .form-control:focus {
          background: #1e293b;
          outline: none;
          box-shadow: 0 0 0 2px var(--accent);
        }
        .chat-input .btn {
          border-radius: 0.75rem;
          height: 46px;
          transition: transform 0.1s;
        }
        .chat-input .btn:hover {
          transform: translateY(-1px);
        }

        /* Scrollbar styling */
        .messages::-webkit-scrollbar {
          width: 6px;
        }
        .messages::-webkit-scrollbar-thumb {
          background: rgba(255, 255, 255, 0.1);
          border-radius: 4px;
        }

        /* Mobile adjustments */
        @media (max-width: 767px) {
          .chat-body { flex-direction: column; }
          .sidebar { width: 100%; order: -1; }
        }
    </style>
</head>
<body>
<main class="chat-shell container">
    <header class="chat-header">
        <div>
            <h2 class="h4 mb-0">Chat Application</h2>
            <small>Real-time chat with WebSocket + STOMP</small>
        </div>
        <div class="ms-auto d-flex align-items-center gap-2">
            <span id="connectionStatus" class="badge bg-secondary">Connecting...</span>
            <button id="clearLog" class="btn btn-sm btn-outline-light">Clear log</button>
        </div>
    </header>

    <section class="chat-body">
        <section class="messages" id="messages" role="log" aria-live="polite"></section>
        <aside class="sidebar d-none d-md-flex">
            <div>
                <h6 class="mb-1">Status</h6>
                <div id="status" class="d-flex align-items-center">
                    <span class="status-dot status-offline" id="statusDot"></span>
                    <small id="statusText">Disconnected</small>
                </div>
            </div>
            <div>
                <h6 class="mb-1">Users</h6>
                <ul id="userList" class="list-unstyled small mb-0">
                    <li class="text-muted">No presence implemented</li>
                </ul>
            </div>
        </aside>
    </section>

    <form class="chat-input" id="chatForm" onsubmit="return false" aria-label="Send a message">
        <input id="senderInput" type="text" class="form-control" placeholder="Your name..." value="User1" />
        <input id="messageInput" type="text" class="form-control" placeholder="Type your message..." />
        <button id="sendBtn" class="btn btn-primary" type="button" disabled>Send</button>
        <button id="clearBtn" class="btn btn-outline-light" type="button" title="Clear messages">Clear</button>
    </form>
</main>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.1/stomp.min.js"></script>

<script>
    // Config & state
    const ENDPOINT = '/chat';
    const SUBSCRIBE_DEST = '/topic/messages';
    const SEND_DEST = '/app/sendMessage';
    const RECONNECT_BASE = 1500;

    let stompClient = null;
    let connected = false;
    let reconnectDelayMs = RECONNECT_BASE;

    // DOM
    const messagesEl = document.getElementById('messages');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const senderInput = document.getElementById('senderInput');
    const messageInput = document.getElementById('messageInput');
    const statusText = document.getElementById('statusText');
    const statusDot = document.getElementById('statusDot');
    const connectionStatus = document.getElementById('connectionStatus');
    const logEl = document.getElementById('log');
    const clearLogBtn = document.getElementById('clearLog');

    // Util
    function log(...args) {
      const t = new Date().toLocaleTimeString();
      const text = `[${t}] ${args.join(' ')}`;
      if (logEl) {
        logEl.textContent = (logEl.textContent ? logEl.textContent + '\n' : '') + text;
        logEl.scrollTop = logEl.scrollHeight;
      }
      console.log(...args);
    }

    function setConnected(state) {
      connected = !!state;
      sendBtn.disabled = !connected;
      if (connected) {
        connectionStatus.textContent = 'Connected';
        connectionStatus.className = 'badge bg-success';
        statusText.textContent = 'Connected';
        statusDot.className = 'status-dot status-online';
      } else {
        connectionStatus.textContent = 'Disconnected';
        connectionStatus.className = 'badge bg-secondary';
        statusText.textContent = 'Disconnected';
        statusDot.className = 'status-dot status-offline';
      }
    }

    function makeAvatar(name) {
      const initials = (name || 'U').split(' ').map(s => s[0]).join('').substring(0,2).toUpperCase();
      const bgHash = (initials.charCodeAt(0) + (initials.charCodeAt(1)||0)) % 360;
      return { initials, bg: `hsl(${bgHash} 60% 38%)` };
    }

    function appendMessage({ sender, content, ts }) {
      const me = (sender || '').toLowerCase() === (senderInput.value || 'User1').toLowerCase();
      const row = document.createElement('div');
      row.className = 'message-row';

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      const avatarMeta = makeAvatar(sender);
      avatar.textContent = avatarMeta.initials;
      avatar.style.background = avatarMeta.bg;

      const bubbleWrap = document.createElement('div');
      bubbleWrap.style.display = 'flex';
      bubbleWrap.style.flexDirection = 'column';
      bubbleWrap.style.alignItems = me ? 'flex-end' : 'flex-start';

      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + (me ? 'me' : 'other');
      bubble.textContent = content;

      const meta = document.createElement('div');
      meta.className = 'meta';
      const time = new Date(ts || Date.now()).toLocaleTimeString();
      meta.textContent = `${sender || 'Anonymous'} • ${time}`;

      bubbleWrap.appendChild(bubble);
      bubbleWrap.appendChild(meta);

      if(me) {
        row.appendChild(bubbleWrap);
        row.appendChild(avatar);
      } else {
        row.appendChild(avatar);
        row.appendChild(bubbleWrap);
      }

      messagesEl.appendChild(row);
      messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior: 'smooth' });
    }

    // Connection
    function connect() {
      log('Attempting SockJS connection to', ENDPOINT);
      const socket = new SockJS(ENDPOINT);
      stompClient = Stomp.over(socket);
      stompClient.debug = (msg) => log('STOMP', msg);

      stompClient.connect({}, (frame) => {
        log('STOMP CONNECTED:', frame && frame.headers && frame.headers['version'] ? frame.headers['version'] : frame);
        setConnected(true);
        reconnectDelayMs = RECONNECT_BASE; // reset backoff

        stompClient.subscribe(SUBSCRIBE_DEST, (message) => {
          try {
            const body = JSON.parse(message.body);
            appendMessage({ sender: body.sender, content: body.content, ts: body.ts || Date.now() });
          } catch (e) {
            log('Invalid message body', e, message.body);
          }
        });

      }, (err) => {
        log('STOMP ERROR:', err && err.toString ? err.toString() : err);
        setConnected(false);
        scheduleReconnect();
      });

      socket.onclose = function(e) {
        log('SockJS closed', e && e.code ? `code=${e.code}` : e);
        setConnected(false);
        scheduleReconnect();
      };
    }

    function scheduleReconnect() {
      if (connected) return;
      log(`Reconnecting in ${reconnectDelayMs}ms...`);
      setTimeout(() => {
        log('Reconnecting now...');
        connect();
      }, reconnectDelayMs);
      reconnectDelayMs = Math.min(Math.floor(reconnectDelayMs * 1.5), 30000);
    }

    // UI actions
    function sendMessage() {
      if (!stompClient || !connected) {
        log('Not connected — cannot send.');
        return;
      }
      const sender = (senderInput.value || 'Anonymous').trim();
      const content = (messageInput.value || '').trim();
      if (!content) return;
      const payload = { sender, content, ts: Date.now() };
      try {
        stompClient.send(SEND_DEST, {}, JSON.stringify(payload));
        messageInput.value = '';
        messageInput.focus();
      } catch (e) {
        log('Send failed', e);
      }
    }

    // Events
    sendBtn.addEventListener('click', sendMessage);
    clearBtn.addEventListener('click', () => { messagesEl.innerHTML = ''; });
    clearLogBtn.addEventListener('click', () => { logEl.textContent = ''; });
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    window.addEventListener('load', () => {
      setConnected(false);
      connect();
      messageInput.focus();
    });
</script>
</body>
</html>